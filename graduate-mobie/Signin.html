<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>Title</title>
        <link rel="stylesheet" href="../graduate-mobie/js/Signin.js"/>
        <link rel="stylesheet" href="../graduate-mobie/css/Signin.css" media="all"/>
<!--    引入百度api-->
        <script type="text/javascript" src="//api.map.baidu.com/api?v=2.0&amp;ak=emhCaO88OqIAnGU7MfsuXyyliu0ifXvC"></script>
</head>
    <body>
        <div class="title">
            <img src="../../images/back.png" alt="" class="back" />
            <h4>地点打卡</h4>`
        </div>
        <div id="allmap"></div>
        <div class="circle " onclick="punch()">
            <div class="time"></div>
            <div>签到</div>
        </div>
    </body>
<!--创建地图，获取当前定位以及设置考勤地点定位，进行距离比较-->
<script type="text/javascript">
    var time = document.querySelector('.time')
    var myDate = new Date();
    time.innerHTML = myDate.getFullYear() + '-' + (myDate.getMonth()+1)+'-'+myDate.getDate(); // 获取当前时间

    var map = new BMap.Map("allmap");
    var point = new BMap.Point(116.404, 39.915);
    map.centerAndZoom(point, 20);
    var pointAttendance
    var geolocation = new BMap.Geolocation();
    geolocation.getCurrentPosition(function (r) {
        if (this.getStatus() == BMAP_STATUS_SUCCESS) {
            var mk = new BMap.Marker(r.point);
            map.addOverlay(mk); // 标出自己的当前所在地
            map.panTo(r.point); // 地图中心移动到自己的当前位置
            point = new BMap.Point(r.point.lng, r.point.lat); // 获取自己当前位置经纬度
            var coordinate = "28.8776683, 105.44852407";// 设置考勤点经纬度
            var arr = coordinate.split(",");// 切割经纬度
            var lon = arr[1];
            var lat = arr[0];
            pointAttendance = new BMap.Point(lon, lat);
            var circle = new BMap.Circle(pointAttendance, 1000, { // 考勤地点范围
                fillColor: "blue", // 圆形颜色
                strokeWeight: 1,
                fillOpacity: 0.2,
                strokeOpacity: 0.2
            });
            map.addOverlay(circle);
            var r = new BMap.Marker(pointAttendance);
            map.addOverlay(r); // 标出考勤点的位置
        } else {
            alert('failed' + this.getStatus());
        }
    }, { enableHighAccuracy: true })

    // 签到
    // 在签到函数中调用sendLocationData，将经度和纬度传递给后端
    function signIn() {
        var distance = map.getDistance(point, pointAttendance).toFixed(2);
        if (distance <= 1000) {
            sendLocationData(point.lng, point.lat);
            GetLocation();
        } else {
            alert("超出考勤地点范围，签到失败");
        }
    }
    // 地址逆解析
    function GetLocation() {
        var geoc = new BMap.Geocoder();
        geoc.getLocation(point, function (rs) {// 获取当前定位所在详细地址
            var addComp = rs.addressComponents;
            var address = addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber;
            alert("您已在" + address + "签到成功")
        });
    }
    // 点击签到
    function punch() {
        // var lng = point.lng; // 获取经度
        // var lat = point.lat; // 获取纬度
        this.signIn()
    }
    function sendLocationData(lng, lat) {

        var myDate = new Date();
        // 构造要发送的数据对象
        var data = {
            phone:localStorage.getItem("bStudent"),
            ckLongitude: lng,
            ckLatitude: lat,
            // ckName:,
            // ckAddress:,
            //cName:,
            //comName:,
            //ckTpye:,
            ckTime: myDate
        };

        // 发送POST请求
        fetch('http://127.0.0.1:8089/api/signin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    alert('数据已成功发送到后端');
                } else {
                    alert('发送数据到后端失败');
                }
            })
            .catch(error => {
                console.error('发生错误:', error);
            });
    }
</script>
</html>