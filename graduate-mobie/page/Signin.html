<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>Title</title>
        <link rel="stylesheet" href="../js/Signin.js"/>
    <link rel="stylesheet" href="../css/public.css">
    <link rel="stylesheet" href="../css/public.css">
    <!-- 引入图标库 -->
    <link rel="stylesheet" href="../lib/iconfont/iconfont.css">

    <link rel="stylesheet" href="../css/Signin.css" media="all"/>
<!--    引入百度api-->
        <script type="text/javascript" src="//api.map.baidu.com/api?v=2.0&amp;ak=emhCaO88OqIAnGU7MfsuXyyliu0ifXvC"></script>
</head>
    <body>
        <div class="title">
            <h4>地点打卡</h4>
        </div>
        <div id="allmap"></div>
        <div class="circle " onclick="punch()">
            <div class="time"></div>
            <div>签到</div>
        </div>


        <!-- 底部导航栏 -->
        <div class="toolbar">
            <a href="../page/Signin.html">
                <i class="iconfont icon-index-copy"></i>
                <span>首页</span>
            </a>
            <a href="../page/announcement.html">
                <i class="iconfont icon-youhuiquan"></i>
                <span>通知</span>
            </a>
            <a href="../page/employment_details.html" class="active">
                <i class="iconfont icon-iconfront-"></i>
                <span>就业</span>
            </a>
            <a href="../page/me.html">
                <i class="iconfont icon-7"></i>
                <span>我的</span>
            </a>
        </div>

    </body>
<!--创建地图，获取当前定位以及设置考勤地点定位，进行距离比较-->
<script type="text/javascript">
    //获取地址
    var geoc = new BMap.Geocoder();
    var address ="";
    var time = document.querySelector('.time')
    var myDate = new Date();
    time.innerHTML = myDate.getFullYear() + '-' + (myDate.getMonth()+1)+'-'+myDate.getDate(); // 获取当前时间

    var map = new BMap.Map("allmap");
    //公司地址
    var point = new BMap.Point(28.8776683, 105.44852407);

    map.centerAndZoom(point, 18);
    var pointAttendance
    var geolocation = new BMap.Geolocation();
    geolocation.getCurrentPosition(function (r) {
        if (this.getStatus() == BMAP_STATUS_SUCCESS) {
            var mk = new BMap.Marker(r.point);
            map.addOverlay(mk); // 标出自己的当前所在地
            map.panTo(r.point); // 地图中心移动到自己的当前位置
            // point = new BMap.Point(r.point.lng, r.point.lat); // 获取自己当前位置经纬度

            var coordinate = "28.8776683, 105.44852407";// 设置考勤点经纬度
            var arr = coordinate.split(",");// 切割经纬度
            var lon = arr[1];
            var lat = arr[0];
            pointAttendance = new BMap.Point(lon, lat);
            var circle = new BMap.Circle(pointAttendance, 1000, { // 考勤地点范围
                fillColor: "blue", // 圆形颜色
                strokeWeight: 1,
                fillOpacity: 0.2,
                strokeOpacity: 0.2
            });
            map.addOverlay(circle);
            var r = new BMap.Marker(pointAttendance);
            map.addOverlay(r); // 标出考勤点的位置
        } else {
            alert('failed' + this.getStatus());
        }
    }, { enableHighAccuracy: true })

    // 签到
    // 在签到函数中调用sendLocationData，将经度和纬度传递给后端
    function signIn() {
        var distance = map.getDistance(point, pointAttendance);
        alert(distance);
        //计算自己和公司距离判断考勤类型
        var ckTpye=(distance >1000)? "1":"2";
        if (distance <= 1000) {
            if (address===""){
                geoc.getLocation(point,function (rs){
                    var addComp = rs.addressComponents;
                    address = addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber;
                    sendLocationData(point.lng, point.lat,ckTpye);
                    GetLocation();
                })
            }
        }
    }
    // 地址逆解析
    function GetLocation() {

        geoc.getLocation(point, function (rs) {// 获取当前定位所在详细地址
            var addComp = rs.addressComponents;
            address = addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber;
            alert("您已在" + address + "签到成功")
            location.reload();
        });
    }
    // 点击签到
    function punch() {
        var lng = point.lng; // 获取经度
        var lat = point.lat; // 获取纬度
        this.signIn()
    }
    function sendLocationData(lng, lat,ckTpye) {
        var myDate = new Date();
        // 构造要发送的数据对象
        var stu= localStorage.getItem("bStudent")
        stu=JSON.parse(stu);
        var data = {
            phone:stu.sNumbers,
            ckName:stu.sName,
            bClass:stu.classId,
            cId: stu.compenyId,//就是这个
            ckAddress:address,
            ckTpye:ckTpye,
            ckTime: myDate,
            ckLongitude: lng,
            ckLatitude: lat
        };
        // 发送POST请求
        fetch('http://127.0.0.1:8089/api/signin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    // window.location.href="./page/SigninPage.html"
                } else {
                    alert('发送数据到后端失败');
                }
            })
            .catch(error => {
                console.error('发生错误:', error);
            });
    }
</script>
</html>